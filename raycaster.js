class RayCaster {
    constructor() {
        this.obstacles = [
            {
                "x1": 123,
                "y1": 109,
                "x2": 157,
                "y2": 108
              },
              {
                "x1": 157,
                "y1": 108,
                "x2": 156,
                "y2": 151
              },
              {
                "x1": 156,
                "y1": 151,
                "x2": 184,
                "y2": 151
              },
              {
                "x1": 184,
                "y1": 151,
                "x2": 182,
                "y2": 108
              },
              {
                "x1": 182,
                "y1": 108,
                "x2": 213,
                "y2": 108
              },
              {
                "x1": 213,
                "y1": 108,
                "x2": 215,
                "y2": 224
              },
              {
                "x1": 215,
                "y1": 224,
                "x2": 180,
                "y2": 222
              },
              {
                "x1": 180,
                "y1": 222,
                "x2": 182,
                "y2": 175
              },
              {
                "x1": 182,
                "y1": 175,
                "x2": 156,
                "y2": 174
              },
              {
                "x1": 156,
                "y1": 174,
                "x2": 155,
                "y2": 218
              },
              {
                "x1": 155,
                "y1": 218,
                "x2": 121,
                "y2": 217
              },
              {
                "x1": 121,
                "y1": 217,
                "x2": 122,
                "y2": 108
              },
              {
                "x1": 234,
                "y1": 156,
                "x2": 262,
                "y2": 156
              },
              {
                "x1": 262,
                "y1": 156,
                "x2": 260,
                "y2": 222
              },
              {
                "x1": 260,
                "y1": 222,
                "x2": 233,
                "y2": 221
              },
              {
                "x1": 233,
                "y1": 221,
                "x2": 232,
                "y2": 156
              },
              {
                "x1": 231,
                "y1": 111,
                "x2": 230,
                "y2": 136
              },
              {
                "x1": 230,
                "y1": 136,
                "x2": 259,
                "y2": 135
              },
              {
                "x1": 259,
                "y1": 135,
                "x2": 255,
                "y2": 109
              },
              {
                "x1": 255,
                "y1": 109,
                "x2": 233,
                "y2": 110
              },
              {
                "x1": 307,
                "y1": 106,
                "x2": 271,
                "y2": 106
              },
              {
                "x1": 271,
                "y1": 106,
                "x2": 283,
                "y2": 182
              },
              {
                "x1": 283,
                "y1": 182,
                "x2": 299,
                "y2": 182
              },
              {
                "x1": 299,
                "y1": 182,
                "x2": 307,
                "y2": 107
              },
              {
                "x1": 282,
                "y1": 201,
                "x2": 301,
                "y2": 202
              },
              {
                "x1": 301,
                "y1": 202,
                "x2": 300,
                "y2": 219
              },
              {
                "x1": 300,
                "y1": 219,
                "x2": 281,
                "y2": 217
              },
              {
                "x1": 281,
                "y1": 217,
                "x2": 282,
                "y2": 201
              },
              {
                "x1": 119,
                "y1": 249,
                "x2": 146,
                "y2": 249
              },
              {
                "x1": 146,
                "y1": 249,
                "x2": 145,
                "y2": 276
              },
              {
                "x1": 145,
                "y1": 276,
                "x2": 161,
                "y2": 276
              },
              {
                "x1": 161,
                "y1": 276,
                "x2": 162,
                "y2": 248
              },
              {
                "x1": 162,
                "y1": 248,
                "x2": 180,
                "y2": 249
              },
              {
                "x1": 180,
                "y1": 249,
                "x2": 177,
                "y2": 316
              },
              {
                "x1": 177,
                "y1": 316,
                "x2": 157,
                "y2": 313
              },
              {
                "x1": 157,
                "y1": 313,
                "x2": 158,
                "y2": 292
              },
              {
                "x1": 158,
                "y1": 292,
                "x2": 144,
                "y2": 292
              },
              {
                "x1": 144,
                "y1": 292,
                "x2": 142,
                "y2": 312
              },
              {
                "x1": 142,
                "y1": 312,
                "x2": 119,
                "y2": 312
              },
              {
                "x1": 119,
                "y1": 312,
                "x2": 119,
                "y2": 248
              },
              {
                "x1": 201,
                "y1": 285,
                "x2": 185,
                "y2": 285
              },
              {
                "x1": 185,
                "y1": 285,
                "x2": 184,
                "y2": 316
              },
              {
                "x1": 184,
                "y1": 316,
                "x2": 201,
                "y2": 315
              },
              {
                "x1": 201,
                "y1": 315,
                "x2": 201,
                "y2": 287
              },
              {
                "x1": 199,
                "y1": 266,
                "x2": 186,
                "y2": 266
              },
              {
                "x1": 186,
                "y1": 266,
                "x2": 186,
                "y2": 253
              },
              {
                "x1": 186,
                "y1": 253,
                "x2": 201,
                "y2": 252
              },
              {
                "x1": 201,
                "y1": 252,
                "x2": 201,
                "y2": 264
              },
              {
                "x1": 218,
                "y1": 250,
                "x2": 204,
                "y2": 251
              },
              {
                "x1": 204,
                "y1": 251,
                "x2": 207,
                "y2": 316
              },
              {
                "x1": 207,
                "y1": 316,
                "x2": 243,
                "y2": 316
              },
              {
                "x1": 243,
                "y1": 316,
                "x2": 241,
                "y2": 297
              },
              {
                "x1": 241,
                "y1": 297,
                "x2": 221,
                "y2": 298
              },
              {
                "x1": 221,
                "y1": 298,
                "x2": 221,
                "y2": 286
              },
              {
                "x1": 221,
                "y1": 286,
                "x2": 234,
                "y2": 286
              },
              {
                "x1": 234,
                "y1": 286,
                "x2": 232,
                "y2": 276
              },
              {
                "x1": 232,
                "y1": 276,
                "x2": 220,
                "y2": 275
              },
              {
                "x1": 220,
                "y1": 275,
                "x2": 218,
                "y2": 250
              },
              {
                "x1": 279,
                "y1": 247,
                "x2": 270,
                "y2": 248
              },
              {
                "x1": 270,
                "y1": 248,
                "x2": 263,
                "y2": 257
              },
              {
                "x1": 263,
                "y1": 257,
                "x2": 272,
                "y2": 257
              },
              {
                "x1": 272,
                "y1": 257,
                "x2": 277,
                "y2": 249
              },
              {
                "x1": 290,
                "y1": 248,
                "x2": 285,
                "y2": 248
              },
              {
                "x1": 285,
                "y1": 248,
                "x2": 278,
                "y2": 258
              },
              {
                "x1": 278,
                "y1": 258,
                "x2": 285,
                "y2": 257
              },
              {
                "x1": 285,
                "y1": 257,
                "x2": 291,
                "y2": 249
              },
              {
                "x1": 325,
                "y1": 256,
                "x2": 294,
                "y2": 256
              },
              {
                "x1": 294,
                "y1": 256,
                "x2": 291,
                "y2": 318
              },
              {
                "x1": 291,
                "y1": 318,
                "x2": 325,
                "y2": 317
              },
              {
                "x1": 325,
                "y1": 317,
                "x2": 324,
                "y2": 305
              },
              {
                "x1": 324,
                "y1": 305,
                "x2": 306,
                "y2": 305
              },
              {
                "x1": 306,
                "y1": 305,
                "x2": 307,
                "y2": 292
              },
              {
                "x1": 307,
                "y1": 292,
                "x2": 317,
                "y2": 292
              },
              {
                "x1": 317,
                "y1": 292,
                "x2": 317,
                "y2": 284
              },
              {
                "x1": 317,
                "y1": 284,
                "x2": 307,
                "y2": 284
              },
              {
                "x1": 307,
                "y1": 284,
                "x2": 307,
                "y2": 275
              },
              {
                "x1": 307,
                "y1": 275,
                "x2": 320,
                "y2": 275
              },
              {
                "x1": 320,
                "y1": 275,
                "x2": 324,
                "y2": 256
              },
              {
                "x1": 331,
                "y1": 316,
                "x2": 349,
                "y2": 315
              },
              {
                "x1": 349,
                "y1": 315,
                "x2": 349,
                "y2": 290
              },
              {
                "x1": 349,
                "y1": 290,
                "x2": 358,
                "y2": 290
              },
              {
                "x1": 358,
                "y1": 290,
                "x2": 359,
                "y2": 317
              },
              {
                "x1": 359,
                "y1": 317,
                "x2": 372,
                "y2": 316
              },
              {
                "x1": 372,
                "y1": 316,
                "x2": 369,
                "y2": 279
              },
              {
                "x1": 369,
                "y1": 279,
                "x2": 344,
                "y2": 279
              },
              {
                "x1": 344,
                "y1": 279,
                "x2": 342,
                "y2": 274
              },
              {
                "x1": 342,
                "y1": 274,
                "x2": 331,
                "y2": 277
              },
              {
                "x1": 331,
                "y1": 277,
                "x2": 331,
                "y2": 313
              },
              {
                "x1": 392,
                "y1": 254,
                "x2": 377,
                "y2": 257
              },
              {
                "x1": 377,
                "y1": 257,
                "x2": 378,
                "y2": 315
              },
              {
                "x1": 378,
                "y1": 315,
                "x2": 410,
                "y2": 315
              },
              {
                "x1": 410,
                "y1": 315,
                "x2": 410,
                "y2": 303
              },
              {
                "x1": 410,
                "y1": 303,
                "x2": 391,
                "y2": 303
              },
              {
                "x1": 391,
                "y1": 303,
                "x2": 392,
                "y2": 293
              },
              {
                "x1": 392,
                "y1": 293,
                "x2": 400,
                "y2": 292
              },
              {
                "x1": 400,
                "y1": 292,
                "x2": 401,
                "y2": 279
              },
              {
                "x1": 401,
                "y1": 279,
                "x2": 393,
                "y2": 280
              },
              {
                "x1": 393,
                "y1": 280,
                "x2": 392,
                "y2": 255
              },
              {
                "x1": 429,
                "y1": 299,
                "x2": 450,
                "y2": 294
              },
              {
                "x1": 450,
                "y1": 294,
                "x2": 450,
                "y2": 278
              },
              {
                "x1": 450,
                "y1": 278,
                "x2": 413,
                "y2": 280
              },
              {
                "x1": 413,
                "y1": 280,
                "x2": 416,
                "y2": 313
              },
              {
                "x1": 416,
                "y1": 313,
                "x2": 448,
                "y2": 314
              },
              {
                "x1": 448,
                "y1": 314,
                "x2": 450,
                "y2": 305
              },
              {
                "x1": 450,
                "y1": 305,
                "x2": 427,
                "y2": 305
              },
              {
                "x1": 427,
                "y1": 305,
                "x2": 429,
                "y2": 300
              },
              {
                "x1": 424,
                "y1": 287,
                "x2": 428,
                "y2": 292
              },
              {
                "x1": 428,
                "y1": 292,
                "x2": 435,
                "y2": 290
              },
              {
                "x1": 435,
                "y1": 290,
                "x2": 435,
                "y2": 286
              },
              {
                "x1": 435,
                "y1": 286,
                "x2": 424,
                "y2": 286
              },
              {
                "x1": 470,
                "y1": 280,
                "x2": 456,
                "y2": 281
              },
              {
                "x1": 456,
                "y1": 281,
                "x2": 456,
                "y2": 316
              },
              {
                "x1": 456,
                "y1": 316,
                "x2": 471,
                "y2": 316
              },
              {
                "x1": 471,
                "y1": 316,
                "x2": 472,
                "y2": 299
              },
              {
                "x1": 472,
                "y1": 299,
                "x2": 496,
                "y2": 291
              },
              {
                "x1": 496,
                "y1": 291,
                "x2": 496,
                "y2": 281
              },
              {
                "x1": 496,
                "y1": 281,
                "x2": 470,
                "y2": 287
              },
              {
                "x1": 470,
                "y1": 287,
                "x2": 470,
                "y2": 282
              },
              {
                "x1": 493,
                "y1": 245,
                "x2": 485,
                "y2": 246
              },
              {
                "x1": 485,
                "y1": 246,
                "x2": 496,
                "y2": 254
              },
              {
                "x1": 496,
                "y1": 254,
                "x2": 505,
                "y2": 252
              },
              {
                "x1": 505,
                "y1": 252,
                "x2": 493,
                "y2": 246
              },
              {
                "x1": 508,
                "y1": 244,
                "x2": 500,
                "y2": 244
              },
              {
                "x1": 500,
                "y1": 244,
                "x2": 510,
                "y2": 253
              },
              {
                "x1": 510,
                "y1": 253,
                "x2": 518,
                "y2": 253
              },
              {
                "x1": 518,
                "y1": 253,
                "x2": 509,
                "y2": 244
              },
              {
                "x1": 562,
                "y1": 248,
                "x2": 545,
                "y2": 246
              },
              {
                "x1": 545,
                "y1": 246,
                "x2": 541,
                "y2": 315
              },
              {
                "x1": 541,
                "y1": 315,
                "x2": 583,
                "y2": 315
              },
              {
                "x1": 583,
                "y1": 315,
                "x2": 584,
                "y2": 300
              },
              {
                "x1": 584,
                "y1": 300,
                "x2": 559,
                "y2": 300
              },
              {
                "x1": 559,
                "y1": 300,
                "x2": 560,
                "y2": 287
              },
              {
                "x1": 560,
                "y1": 287,
                "x2": 571,
                "y2": 287
              },
              {
                "x1": 571,
                "y1": 287,
                "x2": 572,
                "y2": 277
              },
              {
                "x1": 572,
                "y1": 277,
                "x2": 561,
                "y2": 276
              },
              {
                "x1": 561,
                "y1": 276,
                "x2": 562,
                "y2": 249
              },
              {
                "x1": 611,
                "y1": 277,
                "x2": 588,
                "y2": 277
              },
              {
                "x1": 588,
                "y1": 277,
                "x2": 590,
                "y2": 317
              },
              {
                "x1": 590,
                "y1": 317,
                "x2": 619,
                "y2": 317
              },
              {
                "x1": 619,
                "y1": 317,
                "x2": 612,
                "y2": 277
              },
              {
                "x1": 605,
                "y1": 289,
                "x2": 598,
                "y2": 290
              },
              {
                "x1": 598,
                "y1": 290,
                "x2": 597,
                "y2": 306
              },
              {
                "x1": 597,
                "y1": 306,
                "x2": 606,
                "y2": 305
              },
              {
                "x1": 606,
                "y1": 305,
                "x2": 606,
                "y2": 290
              },
              {
                "x1": 681,
                "y1": 278,
                "x2": 646,
                "y2": 281
              },
              {
                "x1": 646,
                "y1": 281,
                "x2": 641,
                "y2": 319
              },
              {
                "x1": 641,
                "y1": 319,
                "x2": 674,
                "y2": 317
              },
              {
                "x1": 674,
                "y1": 317,
                "x2": 687,
                "y2": 321
              },
              {
                "x1": 687,
                "y1": 321,
                "x2": 694,
                "y2": 315
              },
              {
                "x1": 694,
                "y1": 315,
                "x2": 690,
                "y2": 306
              },
              {
                "x1": 690,
                "y1": 306,
                "x2": 694,
                "y2": 241
              },
              {
                "x1": 694,
                "y1": 241,
                "x2": 674,
                "y2": 243
              },
              {
                "x1": 674,
                "y1": 243,
                "x2": 681,
                "y2": 278
              },
              {
                "x1": 671,
                "y1": 291,
                "x2": 654,
                "y2": 292
              },
              {
                "x1": 654,
                "y1": 292,
                "x2": 655,
                "y2": 304
              },
              {
                "x1": 655,
                "y1": 304,
                "x2": 673,
                "y2": 304
              },
              {
                "x1": 673,
                "y1": 304,
                "x2": 672,
                "y2": 292
              },
              {
                "x1": 722,
                "y1": 271,
                "x2": 705,
                "y2": 275
              },
              {
                "x1": 705,
                "y1": 275,
                "x2": 705,
                "y2": 322
              },
              {
                "x1": 705,
                "y1": 322,
                "x2": 723,
                "y2": 321
              },
              {
                "x1": 723,
                "y1": 321,
                "x2": 724,
                "y2": 294
              },
              {
                "x1": 724,
                "y1": 294,
                "x2": 731,
                "y2": 288
              },
              {
                "x1": 731,
                "y1": 288,
                "x2": 753,
                "y2": 289
              },
              {
                "x1": 753,
                "y1": 289,
                "x2": 753,
                "y2": 274
              },
              {
                "x1": 753,
                "y1": 274,
                "x2": 733,
                "y2": 275
              },
              {
                "x1": 733,
                "y1": 275,
                "x2": 723,
                "y2": 279
              },
              {
                "x1": 723,
                "y1": 279,
                "x2": 723,
                "y2": 272
              },
              {
                "x1": 791,
                "y1": 276,
                "x2": 762,
                "y2": 280
              },
              {
                "x1": 762,
                "y1": 280,
                "x2": 753,
                "y2": 315
              },
              {
                "x1": 753,
                "y1": 315,
                "x2": 789,
                "y2": 311
              },
              {
                "x1": 789,
                "y1": 311,
                "x2": 794,
                "y2": 317
              },
              {
                "x1": 794,
                "y1": 317,
                "x2": 809,
                "y2": 314
              },
              {
                "x1": 809,
                "y1": 314,
                "x2": 804,
                "y2": 296
              },
              {
                "x1": 804,
                "y1": 296,
                "x2": 803,
                "y2": 274
              },
              {
                "x1": 803,
                "y1": 274,
                "x2": 791,
                "y2": 275
              },
              {
                "x1": 781,
                "y1": 289,
                "x2": 768,
                "y2": 289
              },
              {
                "x1": 768,
                "y1": 289,
                "x2": 766,
                "y2": 302
              },
              {
                "x1": 766,
                "y1": 302,
                "x2": 784,
                "y2": 301
              },
              {
                "x1": 784,
                "y1": 301,
                "x2": 782,
                "y2": 289
              },
              {
                "x1": 834,
                "y1": 272,
                "x2": 817,
                "y2": 272
              },
              {
                "x1": 817,
                "y1": 272,
                "x2": 822,
                "y2": 315
              },
              {
                "x1": 822,
                "y1": 315,
                "x2": 838,
                "y2": 315
              },
              {
                "x1": 838,
                "y1": 315,
                "x2": 847,
                "y2": 302
              },
              {
                "x1": 847,
                "y1": 302,
                "x2": 854,
                "y2": 317
              },
              {
                "x1": 854,
                "y1": 317,
                "x2": 873,
                "y2": 317
              },
              {
                "x1": 873,
                "y1": 317,
                "x2": 879,
                "y2": 274
              },
              {
                "x1": 879,
                "y1": 274,
                "x2": 861,
                "y2": 274
              },
              {
                "x1": 861,
                "y1": 274,
                "x2": 858,
                "y2": 295
              },
              {
                "x1": 858,
                "y1": 295,
                "x2": 854,
                "y2": 286
              },
              {
                "x1": 854,
                "y1": 286,
                "x2": 844,
                "y2": 285
              },
              {
                "x1": 844,
                "y1": 285,
                "x2": 838,
                "y2": 294
              },
              {
                "x1": 838,
                "y1": 294,
                "x2": 835,
                "y2": 273
              }
        ];
        this.user = [];
        this.facing = 0;
        this.rayDist = 300;
        this.rotationOffset = 0;
    }

    setObstacles(obstacles) {
        this.obstacles = obstacles;
    }

    draw() {
        clear();

        this.updateUserRays();
        this.drawUserRays();

        stroke(255);
        for (let o of this.obstacles) {
            line(o.x1, o.y1, o.x2, o.y2);
        }
    }

    updateUserRays() {
        this.user = [];

        const maxAngle = TWO_PI;

        // let rotationOffsetTarget
        // const m = createVector(mouseX, mouseY);
        // const pm = createVector(pmouseX, pmouseY);

        // if(m.dist(pm) < 1){
        //   rotationOffsetTarget = rotationOffset;
        // }
        // else{
        //   rotationOffsetTarget = createVector(mouseX - pmouseX, mouseY - pmouseY).heading();
        // }
        // rotationOffset = lerp(rotationOffset, rotationOffsetTarget, 0.3);
        this.rotationOffset = 0;

        const rad = this.rayDist;
        const inc = maxAngle / 2048;

        for (let i = this.rotationOffset; i < maxAngle + this.rotationOffset; i += inc) {
            const x1 = mouseX;
            const y1 = mouseY;
            const x2 = mouseX + rad * cos(i);
            const y2 = mouseY + rad * sin(i);

            let ray = {
                x1,
                y1,
                x2,
                y2
            };
            const intersection = this.checkRayCollision(ray);

            if (intersection) {
                ray.x2 = intersection.x;
                ray.y2 = intersection.y;
            }

            this.user.push(ray);
        }
    }

    drawUserRays() {
        for (let r of this.user) {
            push();
            stroke(50, 50);
            line(r.x1, r.y1, r.x2, r.y2);
            pop();
        }
    }

    checkRayCollision(ray) {
        let nearestCollisionPoint;
        let nearestDist = this.rayDist;

        for (let o of this.obstacles) {
            let collisionPoint = this.getLineLineIntersection(ray, o);
            if (collisionPoint) {
                if (dist(collisionPoint.x, collisionPoint.y, ray.x1, ray.y1) < nearestDist) {
                    nearestCollisionPoint = collisionPoint;
                    nearestDist = dist(collisionPoint.x, collisionPoint.y, ray.x1, ray.y1);
                }
            }
        }

        return nearestCollisionPoint;
    }

    getLineLineIntersection(l1, l2) {
        const x1 = l1.x1;
        const x2 = l1.x2;
        const x3 = l2.x1;
        const x4 = l2.x2;

        const y1 = l1.y1;
        const y2 = l1.y2;
        const y3 = l2.y1;
        const y4 = l2.y2;


        const den = (x1 - x2) * (y3 - y4) - (y1 - y2) * (x3 - x4);

        if (den == 0) return;

        const t = ((x1 - x3) * (y3 - y4) - (y1 - y3) * (x3 - x4)) / den;
        const u = -((x1 - x2) * (y1 - y3) - (y1 - y2) * (x1 - x3)) / den;


        if (t >= 0 && t <= 1 && u >= 0 && u <= 1) {

            let x = x1 + t * (x2 - x1);
            let y = y1 + t * (y2 - y1);

            return {
                x,
                y
            };
        }

        return;
    }
}